# ランキングシステム仕様書

## 概要
プレイヤーの実績解除状況を管理し、全プレイヤーのランキングを表示するシステム。

## コマンド仕様

### /adv_rank <ID> コマンド

#### 概要
指定された実績IDに対する全プレイヤーのランキングを表示する。

#### コマンド形式
```
/adv_rank <ID>
```

#### パラメータ
- **ID**: advancement テーブルの数値ID（必須）
  - 数値のみ受け付ける
  - 存在しないIDの場合はエラーメッセージを表示

#### 動作仕様

1. **入力検証**
   - IDが数値であることを確認
   - IDがデータベースに存在することを確認

2. **ランキング取得**
   - 指定された実績IDに対してプレイヤーのランキングを取得
   - タイムスタンプの昇順（早い順）でソート
   - 1ページあたり10件表示

3. **ページネーション機能**
   - 矢印ボタン（← → ）による前後のページ移動
   - 現在のページ数と総ページ数を表示
   - 各ページに10件ずつのランキング表示
   - クリック可能なチャット要素としてページ移動を実装

4. **表示形式**
   ```
   ===== 実績ランキング: [実績名] =====
   1位: PlayerA - 2024/03/25 14:41:51
   2位: PlayerB - 2024/03/25 15:30:22
   3位: PlayerC - 2024/03/26 09:15:33  ← 自分のランキング（金色で強調）
   4位: PlayerD - 2024/03/26 10:15:20
   ...
   10位: PlayerJ - 2024/03/28 12:30:45
   45位: PlayerC - 2024/03/29 18:25:10  ← 1ページ目のみ、自分がページ外の場合
   ===== ◀ (8/33ページ) ▶ (1 … 6 | 7 | 8̲ | 9 | 10 … 33) =====
   ```

5. **自分のランキング強調表示**
   - コマンド実行者が該当実績を達成している場合、自分のランキングを金色（§6）で強調表示
   - 1ページ目で自分が10位以内に含まれていない場合のみ、別途下部に表示
   - 2ページ目以降では自分の別途表示は行わない

6. **実績名の多言語対応**
   - 実績名はTranslationComponentを使用して、プレイヤーの言語設定に応じた表示
   - フォールバック: 翻訳が見つからない場合は advancement_key をそのまま表示

7. **ページネーション UI**
   - 矢印ボタン（◀ ▶）でページ移動
   - 現在ページと総ページ数を表示: `(現在ページ/総ページ)`
   - 高度なページ番号表示:
     - 7ページ以下: 全ページ表示 `(1 | 2 | 3̲ | 4 | 5)`
     - 8ページ以上: 省略表示 `(1 … 6 | 7 | 8̲ | 9 | 10 … 33)`
   - 現在ページは下線付きで強調（TextDecoration.UNDERLINED）
   - すべてのページ番号がクリック可能
   - ホバー時にコマンド `/adv_rank [実績ID] [ページ番号]` を表示

8. **エラーハンドリング**
   - 無効なID形式: 「エラー: IDは数値で指定してください」
   - 存在しないID: 「エラー: 指定されたID [ID] の実績は存在しません」
   - データベースエラー: 「エラー: ランキングの取得に失敗しました」

#### 権限
- デフォルト: 全プレイヤーが実行可能
- 設定により制限可能: `advancementcompetition.command.adv_rank`

## L キー実績画面の拡張仕様

### ランキング表示統合

実績画面（Lキー）のトップ3表示の下に、詳細ランキングへのリンク情報を追加する。

#### 表示形式
```
[既存のトップ3ランキング表示]

詳細ランキングを見るには:
/adv_rank [実績ID] を実行してください
```

#### 実装要件
1. **実績IDの取得**
   - 表示中の実績に対応するadvancement テーブルのIDを取得
   - プレイヤーがホバーまたは注目している実績の情報を利用

2. **表示位置**
   - 既存のトップ3ランキング表示の直下
   - 視覚的に分かりやすい区切りを設ける

3. **動的コマンド生成**
   - 実績ごとに適切なIDを動的に挿入
   - コピー可能な形式でコマンドを表示

## 実装計画

### Phase 1: データベース構造の変更
1. 新しいテーブル構造の設計
2. 既存コードの影響範囲調査
3. RankingManager クラスの改修

### Phase 2: コード改修
1. **RankingManager.java**
   - getOrCreatePlayerId メソッドの追加 ✅
   - getOrCreateAdvancementId メソッドの追加 ✅
   - recordAdvancementProgressData メソッドの改修 ✅
   - getRankingByAdvancementId メソッドの追加 ✅
   - ページネーション機能の追加（新規）

2. **AdvancementCompetition.java**
   - /adv_rank コマンドの追加 ✅
   - パラメータ検証処理 ✅
   - ページネーション対応（新規）

### Phase 3: 新機能追加
1. **ページネーション機能**
   - RankingManager.java にページネーション対応メソッドの追加
   - AdvancementCompetition.java でページ番号パラメータの処理
   - チャット要素によるページ移動UI実装

2. **L キー画面統合**
   - 実績画面でのランキングリンク表示
   - advancement ID の動的取得機能
   - 既存のランキング表示との統合

## パフォーマンス考慮事項

1. **クエリ最適化**
   - 適切なインデックスの利用
   - 必要最小限のデータ取得

2. **キャッシュ戦略**
   - 実績IDのキャッシュ
   - ランキング結果の一時キャッシュ（オプション）

## セキュリティ考慮事項

1. **SQLインジェクション対策**
   - 全てのクエリで PreparedStatement を使用
   - 入力値の厳密な検証

2. **権限管理**
   - コマンド実行権限の適切な設定

## テスト計画

1. **単体テスト**
   - コマンドパラメータの検証
   - エラーハンドリングの確認

2. **統合テスト**
   - 既存機能との互換性
   - データベース接続テスト

3. **パフォーマンステスト**
   - 大量データでのランキング表示速度
   - 同時アクセス時の動作

## 関連ドキュメント

- **データベース設計・移行**: `spec/database_migration.md`
- **移行SQL**: `migrations/20250811161401_create_new_tables.sql`
- **バックアップ削除**: `migrations/cleanup_backup_tables.sql`