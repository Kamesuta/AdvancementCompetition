# ランキングシステム仕様書

## 概要
プレイヤーの実績解除状況を管理し、全プレイヤーのランキングを表示するシステム。

## コマンド仕様

### /adv_rank <ID> コマンド

#### 概要
指定された実績IDに対する全プレイヤーのランキングを表示する。

#### コマンド形式
```
/adv_rank <ID>
```

#### パラメータ
- **ID**: advancement テーブルの数値ID（必須）
  - 数値のみ受け付ける
  - 存在しないIDの場合はエラーメッセージを表示

#### 動作仕様

1. **入力検証**
   - IDが数値であることを確認
   - IDがデータベースに存在することを確認

2. **ランキング取得**
   - 指定された実績IDに対してプレイヤーのランキングを取得
   - タイムスタンプの昇順（早い順）でソート
   - 上位100名まで表示

3. **表示形式**
   ```
   === 実績ランキング: [実績名] ===
   1位: PlayerA - 2024/03/25 14:41:51
   2位: PlayerB - 2024/03/25 15:30:22
   3位: PlayerC - 2024/03/26 09:15:33
   ...
   ```

4. **エラーハンドリング**
   - 無効なID形式: 「エラー: IDは数値で指定してください」
   - 存在しないID: 「エラー: 指定されたID [ID] の実績は存在しません」
   - データベースエラー: 「エラー: ランキングの取得に失敗しました」

#### 権限
- デフォルト: 全プレイヤーが実行可能
- 設定により制限可能: `advancementcompetition.command.adv_rank`

## 実装計画

### Phase 1: データベース構造の変更
1. 新しいテーブル構造の設計
2. 既存コードの影響範囲調査
3. RankingManager クラスの改修

### Phase 2: コード改修
1. **RankingManager.java**
   - getOrCreatePlayerId メソッドの追加
   - getOrCreateAdvancementId メソッドの追加
   - recordAdvancementProgressData メソッドの改修
   - getRankingByAdvancementId メソッドの追加

2. **AdvancementCompetition.java**
   - /adv_rank コマンドの追加
   - パラメータ検証処理

## パフォーマンス考慮事項

1. **クエリ最適化**
   - 適切なインデックスの利用
   - 必要最小限のデータ取得

2. **キャッシュ戦略**
   - 実績IDのキャッシュ
   - ランキング結果の一時キャッシュ（オプション）

## セキュリティ考慮事項

1. **SQLインジェクション対策**
   - 全てのクエリで PreparedStatement を使用
   - 入力値の厳密な検証

2. **権限管理**
   - コマンド実行権限の適切な設定

## テスト計画

1. **単体テスト**
   - コマンドパラメータの検証
   - エラーハンドリングの確認

2. **統合テスト**
   - 既存機能との互換性
   - データベース接続テスト

3. **パフォーマンステスト**
   - 大量データでのランキング表示速度
   - 同時アクセス時の動作

## 関連ドキュメント

- **データベース設計・移行**: `spec/database_migration.md`
- **移行SQL**: `migrations/20250811161401_create_new_tables.sql`
- **バックアップ削除**: `migrations/cleanup_backup_tables.sql`